<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>polys silly rngame</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: arial, sans-serif;
            background: linear-gradient(135deg, #ffc0cb 0%, #ffffff 100%);
            min-height: 100vh;
            transition: background 0.5s, color 0.5s;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #2d2d2d 0%, #000000 100%);
            color: #fff;
        }
        
        body.dark-mode .container {
            background: rgba(30, 30, 30, 0.9);
            color: #fff;
        }
        
        body.dark-mode .stat-box {
            background: #333;
        }
        
        body.dark-mode .stat-label {
            color: #ccc;
        }
        
        body.dark-mode .cooldown-settings {
            background: #333;
            color: #fff;
        }
        
        body.dark-mode .cooldown-settings label {
            color: #ccc;
        }
        
        body.dark-mode .roll-display {
            background: #222;
            border-color: #ff69b4;
        }
        
        body.dark-mode .rng-box {
            background: transparent;
        }
        
        body.dark-mode .upgrade-box,
        body.dark-mode .inventory,
        body.dark-mode .enchant-inventory,
        body.dark-mode .index-category {
            background: #333;
            color: #fff;
        }
        
        body.dark-mode .inventory-item,
        body.dark-mode .enchant-item {
            background: #444;
        }
        
        body.dark-mode .upgrade-title {
            color: #ff69b4;
        }
        
        body.dark-mode .upgrade-info {
            color: #ccc;
        }
        
        body.dark-mode button {
            background: #555;
        }
        
        body.dark-mode button:hover {
            background: #777;
        }
        
        body.dark-mode input {
            background: #444;
            color: #fff;
            border-color: #666;
        }
        
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1000;
            font-size: 14px;
        }
        
        body.dark-mode .dark-mode-toggle {
            background: #666;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #ff69b4;
            margin-bottom: 30px;
            text-transform: lowercase;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .stat-box {
            background: #f0f0f0;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            text-transform: lowercase;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff69b4;
        }
        .rollers-container {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .roll-display {
            background: #ffffff;
            border: 3px solid #ff69b4;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            width: 180px;
            height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .variant-box {
            background: #ff69b4;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 5px;
            text-transform: lowercase;
        }
        .rng-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
        }
        .roll-result {
            font-size: 28px;
            margin-bottom: 5px;
        }
        .roll-name {
            font-size: 16px;
            color: #ff69b4;
            text-transform: lowercase;
        }
        .enchants-box {
            background: #f0f0f0;
            padding: 5px;
            border-radius: 5px;
            font-size: 12px;
            margin-top: 5px;
            min-height: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 3px;
        }
        .enchant-tag {
            background: #9370db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            text-transform: lowercase;
        }
        .accept-btn {
            background: #ff69b4;
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .decline-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .accept-btn:hover {
            background: #ff85c1;
        }
        .decline-btn:hover {
            background: #ff6666;
        }
        .roll-actions {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        button {
            background: #666;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            text-transform: lowercase;
        }
        button:hover {
            background: #888;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .button-container {
            text-align: center;
            margin-bottom: 30px;
        }
        .sections-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        @media (max-width: 900px) {
            .sections-container {
                grid-template-columns: 1fr;
            }
        }
        .upgrades-section, .inventory-section {
            margin-top: 20px;
        }
        .upgrades-header, .inventory-header, .enchants-header, .index-header {
            background: #666;
            color: white;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            user-select: none;
            margin-bottom: 10px;
            text-transform: lowercase;
        }
        .upgrades-header:hover, .inventory-header:hover, .enchants-header:hover, .index-header:hover {
            background: #888;
        }
        .upgrades-content, .inventory-content, .enchants-content, .index-content {
            display: none;
        }
        .upgrades-content.open, .inventory-content.open, .enchants-content.open, .index-content.open {
            display: block;
        }
        .upgrade-box {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ddd;
            margin-bottom: 10px;
        }
        .upgrade-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff69b4;
            text-transform: lowercase;
        }
        .upgrade-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .inventory, .enchant-inventory {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .inventory-title, .enchant-title {
            font-weight: bold;
            font-size: 18px;
            color: #ff69b4;
            margin-bottom: 15px;
            text-transform: lowercase;
        }
        .inventory-item, .enchant-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .inventory-rng {
            font-weight: bold;
            font-size: 16px;
        }
        .inventory-details {
            font-size: 14px;
            color: #666;
            text-transform: lowercase;
        }
        .index-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .index-category {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
        }
        .index-title {
            font-weight: bold;
            color: #ff69b4;
            margin-bottom: 10px;
            border-bottom: 2px solid #ff69b4;
            padding-bottom: 5px;
            text-transform: lowercase;
        }
        .index-item {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #eee;
            text-transform: lowercase;
        }
        @keyframes flip {
            0% { transform: rotateX(0deg); }
            50% { transform: rotateX(180deg); }
            100% { transform: rotateX(360deg); }
        }
        .flipping {
            animation: flip 0.2s linear infinite;
        }
        .cube {
            display: inline-block;
            width: 80px;
            height: 80px;
            line-height: 80px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #ff69b4, #9370db);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            perspective: 1000px;
        }
        .equip-btn {
            background: #90ee90;
            color: black;
            border: none;
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }
        .unequip-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }
        .star-display {
            font-size: 16px;
            margin-bottom: 3px;
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô Dark Mode</button>
    
    <div class="container">
        <h1>polys silly rngame</h1>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">polycoin</div>
                <div class="stat-value" id="polycoin">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">best roll</div>
                <div class="stat-value" id="best">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">total rolls</div>
                <div class="stat-value" id="rolls">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">enchants</div>
                <div class="stat-value" id="enchants">0</div>
            </div>
        </div>

        <div class="cooldown-settings" style="text-align: center; margin-bottom: 20px; background: #f0f0f0; padding: 15px; border-radius: 10px;">
            <div style="display: inline-block; margin: 0 15px;">
                <label style="font-size: 14px; color: #666;">cooldown if RNG ‚â• </label>
                <input type="number" id="cooldownThreshold" value="0" min="0" step="1000" 
                    onchange="updateCooldownSettings()" 
                    style="width: 100px; padding: 5px; border-radius: 5px; border: 2px solid #ddd;">
            </div>
            <div style="display: inline-block; margin: 0 15px;">
                <label style="font-size: 14px; color: #666;">cooldown time (s): </label>
                <input type="number" id="cooldownTime" value="3" min="0.5" max="60" step="0.5" 
                    onchange="updateCooldownSettings()" 
                    style="width: 80px; padding: 5px; border-radius: 5px; border: 2px solid #ddd;">
            </div>
        </div>

        <div class="rollers-container" id="rollersContainer">
            <!-- rollers will be generated here -->
        </div>

        <div class="button-container">
            <button onclick="roll()" id="rollBtn">roll</button>
        </div>

        <div class="sections-container">
            <div class="left-column">
                <div class="upgrades-section">
                    <div class="upgrades-header" onclick="toggleSection('upgradesContent')">
                        ‚öôÔ∏è upgrades (click to expand) ‚öôÔ∏è
                    </div>
                    <div class="upgrades-content" id="upgradesContent">
                        <div class="upgrade-box">
                            <div class="upgrade-title">add roller</div>
                            <div class="upgrade-info">rollers: <span id="bulkLevel">1</span>/3</div>
                            <div class="upgrade-info">effect: +1 roller on screen</div>
                            <button onclick="buyUpgrade('bulk')" id="bulkBtn">buy (cost: <span id="bulkCost">100</span>)</button>
                        </div>
                        <div class="upgrade-box">
                            <div class="upgrade-title">luck boost</div>
                            <div class="upgrade-info">level: <span id="luckLevel">0</span>/100</div>
                            <div class="upgrade-info">effect: +<span id="luckAmount">0</span> luck</div>
                            <button onclick="buyUpgrade('luck')" id="luckBtn">buy (cost: <span id="luckCost">10</span>)</button>
                        </div>
                        <div class="upgrade-box">
                            <div class="upgrade-title">secret luck</div>
                            <div class="upgrade-info">level: <span id="secretLevel">0</span>/25</div>
                            <div class="upgrade-info">effect: +<span id="secretAmount">0</span> secret luck</div>
                            <button onclick="buyUpgrade('secret')" id="secretBtn">buy (cost: <span id="secretCost">50</span>)</button>
                        </div>
                        <div class="upgrade-box">
                            <div class="upgrade-title">roll speed</div>
                            <div class="upgrade-info">level: <span id="speedLevel">0</span>/25</div>
                            <div class="upgrade-info">speed: <span id="speedAmount">3.0</span>s</div>
                            <button onclick="buyUpgrade('speed')" id="speedBtn">buy (cost: <span id="speedCost">50</span>)</button>
                        </div>
                        <div class="upgrade-box">
                            <div class="upgrade-title">inventory slots</div>
                            <div class="upgrade-info">slots: <span id="invLevel">10</span>/50</div>
                            <div class="upgrade-info">effect: +1 inventory slot</div>
                            <button onclick="buyUpgrade('inventory')" id="invBtn">buy (cost: <span id="invCost">0</span>)</button>
                        </div>
                        <div class="upgrade-box">
                            <div class="upgrade-title">enchant luck</div>
                            <div class="upgrade-info">level: <span id="enchantLuckLevel">0</span>/15</div>
                            <div class="upgrade-info">effect: +<span id="enchantLuckAmount">0</span> enchant luck</div>
                            <button onclick="buyUpgrade('enchantLuck')" id="enchantLuckBtn">buy (cost: <span id="enchantLuckCost">30</span>)</button>
                        </div>
                        <div class="upgrade-box">
                            <div class="upgrade-title">variant luck</div>
                            <div class="upgrade-info">level: <span id="variantLuckLevel">0</span>/30</div>
                            <div class="upgrade-info">effect: +<span id="variantLuckAmount">0</span> variant luck</div>
                            <button onclick="buyUpgrade('variantLuck')" id="variantLuckBtn">buy (cost: <span id="variantLuckCost">50</span>)</button>
                        </div>
                    </div>
                </div>

                <div class="inventory-section">
                    <div class="inventory-header" onclick="toggleSection('inventoryContent')">
                        üì¶ inventory (<span id="invCount">0</span>/<span id="invMax">10</span>)
                    </div>
                    <div class="inventory-content open" id="inventoryContent">
                        <div class="inventory" id="inventoryList"></div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="enchants-section">
                    <div class="enchants-header" onclick="toggleSection('enchantsContent')">
                        üîÆ enchants (<span id="enchantCount">0</span>)
                    </div>
                    <div class="enchants-content open" id="enchantsContent">
                        <div class="inventory-title">equipped orb</div>
                        <div class="inventory" id="equippedEnchant"></div>
                        <div class="inventory-title" style="margin-top: 15px;">enchant orbs</div>
                        <div class="inventory" id="enchantInventoryList"></div>
                    </div>
                </div>

                <div class="index-section">
                    <div class="index-header" onclick="toggleSection('indexContent')">
                        üìö index (click to expand)
                    </div>
                    <div class="index-content" id="indexContent">
                        <div class="index-grid">
                            <div class="index-category">
                                <div class="index-title">variants</div>
                                <div id="variantsIndex"></div>
                            </div>
                            <div class="index-category">
                                <div class="index-title">ranks</div>
                                <div id="ranksIndex"></div>
                            </div>
                            <div class="index-category">
                                <div class="index-title">secrets</div>
                                <div id="secretsIndex"></div>
                            </div>
                            <div class="index-category">
                                <div class="index-title">enchants</div>
                                <div id="enchantsIndex"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // game constants
        const VARIANTS = [
            { name: 'normal', chance: 1, multipliesRNG: 1 },
            { name: 'shiny', chance: 10, multipliesRNG: 10 },
            { name: 'better', chance: 25, multipliesRNG: 25 },
            { name: 'spectral', chance: 50, multipliesRNG: 50 },
            { name: 'divine', chance: 100, multipliesRNG: 100 },
            { name: 'chromatic', chance: 250, multipliesRNG: 250 },
            { name: 'inverted', chance: 500, multipliesRNG: 500 }
        ];

        const RANKS = [
            { name: 'common', min: 1, max: 5 },
            { name: 'rare', min: 5, max: 25 },
            { name: 'decent', min: 25, max: 50 },
            { name: 'natural', min: 50, max: 100 },
            { name: 'exceptional', min: 100, max: 250 },
            { name: 'eclipse', min: 250, max: 500 },
            { name: 'mythic', min: 500, max: 1000 },
            { name: 'divine', min: 1000, max: 5000 },
            { name: 'unordinary', min: 5000, max: 10000 },
            { name: 'unreal', min: 10000, max: 50000 },
            { name: 'eternal', min: 50000, max: 100000 },
            { name: 'iridescence', min: 100000, max: 500000 },
            { name: 'zeta', min: 500000, max: 1000000 },
            { name: 'fantasy', min: 1000000, max: 2015510 },
            { name: 'giant', min: 2015510, max: 5000000 },
            { name: 'ultimate', min: 5000000, max: Infinity }
        ];

        const SECRETS = [
            { name: 'terrible', chance: 250 },
            { name: 'weird', chance: 1000 },
            { name: 'best', chance: 2000 },
            { name: 'invisible', chance: 3530 },
            { name: 'grand', chance: 5000 },
            { name: 'defined', chance: 10000 },
            { name: '?!?!?', chance: 25000 },
            { name: 'nil', chance: 50000 },
            { name: 'impossible', chance: 100000 }
        ];

        const ENCHANT_TYPES = [
            { name: 'luck i', type: 'luck', value: 5, color: '#90ee90', chance: 1/1.5, priority: 1 },
            { name: 'luck ii', type: 'luck', value: 10, color: '#00ff00', chance: 1/5, priority: 2 },
            { name: 'insanity', type: 'luck', value: 50, color: '#00aa00', chance: 1/12500, priority: 3 },
            { name: 'speed i', type: 'speed', value: 0.25, color: '#87ceeb', chance: 1/2.5, priority: 1 },
            { name: 'speed ii', type: 'speed', value: 0.5, color: '#1e90ff', chance: 1/10, priority: 2 },
            { name: 'blitz', type: 'speed', value: 75, color: '#0066cc', chance: 1/17777, priority: 3 },
            { name: 'insight i', type: 'secret', value: 5, color: '#9370db', chance: 1/10, priority: 1 },
            { name: 'insight ii', type: 'secret', value: 25, color: '#8a2be2', chance: 1/50, priority: 2 },
            { name: 'omnipotence', type: 'secret', value: 125, color: '#6a0dad', chance: 1/25000, priority: 3 },
            { name: 'requiem i', type: 'requiem', value: 1, color: '#ff4500', chance: 1/500, priority: 1 },
            { name: 'requiem ii', type: 'requiem', value: 2, color: '#dc143c', chance: 1/10000, priority: 2 },
            { name: 'genesis', type: 'requiem', value: 3, color: '#8b0000', chance: 1/10000000, priority: 3 },
            { name: 'variant i', type: 'variant', value: 0.5, color: '#ffc0cb', chance: 1/25, priority: 1 },
            { name: 'variant ii', type: 'variant', value: 2.5, color: '#ff69b4', chance: 1/100, priority: 2 },
            { name: 'unusuality', type: 'variant', value: 20, color: '#ff1493', chance: 1/33333, priority: 3 },
            { name: 'addition i', type: 'addition', value: 1, color: '#ffaa00', chance: 1/25, priority: 1 },
            { name: 'addition ii', type: 'addition', value: 2, color: '#ff8800', chance: 1/75, priority: 2 },
            { name: 'endless', type: 'addition', value: 5, color: '#ff6600', chance: 1/5000, priority: 3 },
            { name: 'greed', type: 'greed', value: 1, color: '#ffd700', chance: 1/60, priority: 1 },
            { name: 'patience', type: 'patience', value: 1, color: '#00ced1', chance: 1/75, priority: 1 }
        ];

        // game state
        let polycoin = 0;
        let bestRoll = 0;
        let totalRolls = 0;
        let bulkLevel = 1;
        let bulkCost = 100;
        let luckLevel = 0;
        let luckCost = 10;
        let secretLevel = 0;
        let secretCost = 50;
        let speedLevel = 0;
        let speedCost = 50;
        let invLevel = 0;
        let invCost = 0;
        let enchantLuckLevel = 0;
        let enchantLuckCost = 30;
        let variantLuckLevel = 0;
        let variantLuckCost = 50;
        let isRolling = false;
        let inventory = [];
        let enchantOrbs = [];
        let equippedOrb = null;
        let pendingRolls = {};
        let discovered = {
            variants: new Set(),
            ranks: new Set(),
            secrets: new Set(),
            enchants: new Set()
        };
        let cooldownThreshold = 0;
        let cooldownTime = 3;

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const button = document.querySelector('.dark-mode-toggle');
            button.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // Initialize dark mode
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            document.querySelector('.dark-mode-toggle').textContent = '‚òÄÔ∏è Light Mode';
        }

        // load game on start
        loadGame();

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            if (content) {
                content.classList.toggle('open');
            }
        }

        function getRNGColor(rng) {
            if (rng < 1000) return '#aad7e6';
            if (rng < 10000) return '#ffc0cb';
            if (rng < 100000) return '#90ee90';
            if (rng < 1000000) return '#9370db';
            if (rng < 10000000) return 'linear-gradient(90deg, #ff0000, #ffffff)';
            if (rng < 100000000) return 'linear-gradient(90deg, #00ffff, #ffffff)';
            if (rng < 1000000000) return 'linear-gradient(90deg, #000000, #8b0000)';
            if (rng < 10000000000) return 'linear-gradient(25deg, #4ef542, #ffffff)';
            return 'linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3)';
        }

        function calculateRNG() {
            const luck = luckLevel * 0.5 + getTotalEnchantLuck();
            const rng = Math.random() ** (-1.3 - (luck * 0.01));
            return Math.max(1, rng);
        }

        function applyStarBonus(value, stars) {
            if (!stars || stars === 0) return value;
            return value * (1 + (stars * 0.2));
        }

        function getTotalEnchantLuck() {
            let total = 0;
            if (!equippedOrb) return total;
            
            const stars = equippedOrb.stars || 0;
            
            equippedOrb.enchants.forEach(enchant => {
                if (enchant.type === 'luck') total += applyStarBonus(enchant.value, stars);
                if (enchant.type === 'requiem') {
                    if (enchant.value === 1) total += applyStarBonus(5, stars);
                    else if (enchant.value === 2) total += applyStarBonus(10, stars);
                    else if (enchant.value === 3) total += applyStarBonus(50, stars);
                }
                if (enchant.type === 'greed') total -= applyStarBonus(20, stars);
                if (enchant.type === 'patience') total += applyStarBonus(100, stars);
            });
            
            return total;
        }

        function getTotalEnchantSecret() {
            let total = 0;
            if (!equippedOrb) return total;
            
            const stars = equippedOrb.stars || 0;
            
            equippedOrb.enchants.forEach(enchant => {
                if (enchant.type === 'secret') total += applyStarBonus(enchant.value, stars);
                if (enchant.type === 'requiem') {
                    if (enchant.value === 1) total += applyStarBonus(5, stars);
                    else if (enchant.value === 2) total += applyStarBonus(25, stars);
                    else if (enchant.value === 3) total += applyStarBonus(125, stars);
                }
            });
            
            return total;
        }

        function getTotalEnchantSpeed() {
            let total = 0;
            if (!equippedOrb) return total;
            
            const stars = equippedOrb.stars || 0;
            
            equippedOrb.enchants.forEach(enchant => {
                if (enchant.type === 'speed') total += applyStarBonus(enchant.value, stars);
                if (enchant.type === 'requiem') {
                    if (enchant.value === 1) total += applyStarBonus(0.25, stars);
                    else if (enchant.value === 2) total += applyStarBonus(0.5, stars);
                    else if (enchant.value === 3) total += applyStarBonus(75, stars);
                }
                if (enchant.type === 'greed') total -= applyStarBonus(0.7, stars);
                if (enchant.type === 'patience') total -= applyStarBonus(25, stars);
            });
            
            return total;
        }

        function getTotalEnchantVariant() {
            let total = variantLuckLevel * 0.05;
            if (!equippedOrb) return total;
            
            const stars = equippedOrb.stars || 0;
            
            equippedOrb.enchants.forEach(enchant => {
                if (enchant.type === 'variant') total += applyStarBonus(enchant.value, stars);
                if (enchant.type === 'requiem') {
                    if (enchant.value === 1) total += applyStarBonus(0.5, stars);
                    else if (enchant.value === 2) total += applyStarBonus(2.5, stars);
                    else if (enchant.value === 3) total += applyStarBonus(20, stars);
                }
                if (enchant.type === 'patience') total += applyStarBonus(5, stars);
            });
            
            return total;
        }

        function getTotalBulkRolls() {
            let total = bulkLevel;
            if (!equippedOrb) return total;
            
            equippedOrb.enchants.forEach(enchant => {
                if (enchant.type === 'addition') total += enchant.value;
                if (enchant.type === 'greed') total += 2;
                if (enchant.type === 'patience') total += 3;
                if (enchant.type === 'requiem') {
                    if (enchant.value === 1) total += 1;
                    else if (enchant.value === 2) total += 2;
                    else if (enchant.value === 3) total += 5;
                }
            });
            
            return Math.min(total, 3);
        }

        function getRank(rng) {
            for (let i = RANKS.length - 1; i >= 0; i--) {
                if (rng >= RANKS[i].min) {
                    return RANKS[i].name;
                }
            }
            return RANKS[0].name;
        }

        function getVariant() {
            const variantLuck = getTotalEnchantVariant();
            for (let i = VARIANTS.length - 1; i >= 0; i--) {
                const adjustedChance = VARIANTS[i].chance / (1 + variantLuck);
                const random = Math.random();
                if (random <= 1 / adjustedChance) {
                    return VARIANTS[i];
                }
            }
            return VARIANTS[0];
        }

        function checkSecret() {
            const secretLuck = secretLevel * 0.2 + getTotalEnchantSecret();
            const random = Math.random();
            for (let i = SECRETS.length - 1; i >= 0; i--) {
                const adjustedChance = SECRETS[i].chance / (1 + secretLuck);
                if (random <= 1 / adjustedChance) {
                    return SECRETS[i].name;
                }
            }
            return null;
        }

        function generateEnchants(baseRng) {
            if (baseRng < 500) return [];
            
            const generated = {};
            const enchantLuck = enchantLuckLevel * 0.05;
            
            ENCHANT_TYPES.forEach(enchant => {
                const adjustedChance = enchant.chance * (1 + enchantLuck);
                if (Math.random() <= adjustedChance) {
                    // If we already have this type, keep the one with higher priority (better enchant)
                    if (!generated[enchant.type] || generated[enchant.type].priority < enchant.priority) {
                        generated[enchant.type] = {
                            name: enchant.name,
                            type: enchant.type,
                            value: enchant.value,
                            color: enchant.color,
                            priority: enchant.priority
                        };
                    }
                }
            });
            
            // Convert to array and sort by type
            return Object.values(generated).sort((a, b) => a.type.localeCompare(b.type));
        }

        function generateStars() {
            // 1/3 chance to have stars
            if (Math.random() > 1/3) return 0;
            
            // If we have stars, determine how many
            const starRolls = [
                { stars: 1, chance: 1/1 },
                { stars: 2, chance: 1/3 },
                { stars: 3, chance: 1/6 },
                { stars: 4, chance: 1/9 },
                { stars: 5, chance: 1/12 }
            ];
            
            for (let i = starRolls.length - 1; i >= 0; i--) {
                if (Math.random() <= starRolls[i].chance) {
                    return starRolls[i].stars;
                }
            }
            
            return 1; // Default to 1 star
        }

        function updateRollers() {
            const container = document.getElementById('rollersContainer');
            container.innerHTML = '';
            const totalRollers = getTotalBulkRolls();
            for (let i = 0; i < totalRollers; i++) {
                const roller = document.createElement('div');
                roller.className = 'roll-display';
                roller.id = `roller-${i}`;
                roller.innerHTML = `
                    <div class="variant-box"></div>
                    <div class="rng-box">
                        <div class="roll-result">press roll!</div>
                        <div class="roll-name"></div>
                    </div>
                    <div class="enchants-box"></div>
                    <div class="roll-actions" style="display: none;">
                        <button class="accept-btn" onclick="acceptRoll(${i})">‚úì accept</button>
                        <button class="decline-btn" onclick="declineRoll(${i})">‚úó decline</button>
                    </div>
                `;
                container.appendChild(roller);
            }
        }

        function animateRoller(index) {
            const roller = document.getElementById(`roller-${index}`);
            if (!roller) return;
            
            const resultEl = roller.querySelector('.roll-result');
            const variantBox = roller.querySelector('.variant-box');
            const nameEl = roller.querySelector('.roll-name');
            const enchantsBox = roller.querySelector('.enchants-box');
            
            resultEl.classList.add('flipping');
            variantBox.textContent = '';
            nameEl.textContent = '';
            enchantsBox.innerHTML = '';
            
            resultEl.innerHTML = '';
            
            const cube = document.createElement('div');
            cube.className = 'cube flipping';
            resultEl.appendChild(cube);
            
            let animationCount = 0;
            const maxAnimations = 15;
            
            function updateAnimation() {
                if (animationCount >= maxAnimations) {
                    return;
                }
                
                const animatedRNG = Math.random() ** (-1.3);
                cube.textContent = Math.floor(Math.max(1, animatedRNG * 10));
                
                animationCount++;
                if (animationCount < maxAnimations) {
                    setTimeout(updateAnimation, 150);
                }
            }
            
            updateAnimation();
        }

        function displayRoll(index, baseRng, finalRng, rankName, variantName, generatedEnchants) {
            const roller = document.getElementById(`roller-${index}`);
            if (!roller) return;
            
            const resultEl = roller.querySelector('.roll-result');
            const variantBox = roller.querySelector('.variant-box');
            const nameEl = roller.querySelector('.roll-name');
            const enchantsBox = roller.querySelector('.enchants-box');
            const actionElements = roller.querySelector('.roll-actions');
            
            resultEl.classList.remove('flipping');
            resultEl.textContent = finalRng.toFixed(2);
            
            variantBox.textContent = variantName;
            nameEl.textContent = rankName;
            
            if (generatedEnchants && generatedEnchants.length > 0) {
                enchantsBox.innerHTML = generatedEnchants.map(enchant => 
                    `<span class="enchant-tag" style="background: ${enchant.color}">${enchant.name}</span>`
                ).join('');
            } else {
                enchantsBox.innerHTML = '';
            }
            
            actionElements.style.display = 'flex';
            
            const color = getRNGColor(finalRng);
            if (color.includes('gradient')) {
                resultEl.style.background = color;
                resultEl.style.webkitBackgroundClip = 'text';
                resultEl.style.webkitTextFillColor = 'transparent';
                resultEl.style.backgroundClip = 'text';
            } else {
                resultEl.style.background = 'none';
                resultEl.style.webkitTextFillColor = 'inherit';
                resultEl.style.color = color;
            }
        }

        function acceptRoll(index) {
            if (!pendingRolls[index]) return;
            
            const maxSlots = 10 + invLevel;
            if (inventory.length >= maxSlots) {
                alert('inventory is full! buy more slots or decline some rolls.');
                return;
            }
            
            inventory.unshift(pendingRolls[index]);
            
            // Create enchant orb if there are enchants
            if (pendingRolls[index].enchants && pendingRolls[index].enchants.length > 0) {
                const stars = generateStars();
                const orb = {
                    id: Date.now() + Math.random(),
                    enchants: pendingRolls[index].enchants,
                    sourceRNG: pendingRolls[index].finalRng,
                    variant: pendingRolls[index].variant,
                    stars: stars
                };
                enchantOrbs.push(orb);
            }
            
            delete pendingRolls[index];
            
            const roller = document.getElementById(`roller-${index}`);
            if (roller) {
                const actionElements = roller.querySelector('.roll-actions');
                actionElements.style.display = 'none';
            }
            
            updateInventory();
            updateEnchantInventory();
            updateUI();
            saveGame();
        }

        function declineRoll(index) {
            if (!pendingRolls[index]) return;
            
            delete pendingRolls[index];
            
            const roller = document.getElementById(`roller-${index}`);
            if (roller) {
                const actionElements = roller.querySelector('.roll-actions');
                actionElements.style.display = 'none';
            }
        }

        function deleteInventoryItem(index) {
            inventory.splice(index, 1);
            updateInventory();
            saveGame();
        }

        function deleteEnchantOrb(index) {
            // Unequip if this orb is equipped
            if (equippedOrb && enchantOrbs[index].id === equippedOrb.id) {
                equippedOrb = null;
            }
            enchantOrbs.splice(index, 1);
            updateEnchantInventory();
            updateUI();
            updateRollers();
            saveGame();
        }

        function equipEnchantOrb(index) {
            equippedOrb = enchantOrbs[index];
            updateEnchantInventory();
            updateUI();
            updateRollers();
            saveGame();
        }

        function unequipEnchantOrb() {
            equippedOrb = null;
            updateEnchantInventory();
            updateUI();
            updateRollers();
            saveGame();
        }

        function roll() {
            if (isRolling) return;
            
            isRolling = true;
            document.getElementById('rollBtn').disabled = true;
            
            const totalRollers = getTotalBulkRolls();
            for (let i = 0; i < totalRollers; i++) {
                animateRoller(i);
            }
            
            const baseSpeed = 3;
            const speedReduction = speedLevel * 0.1 + getTotalEnchantSpeed();
            const rollSpeed = Math.max(0.05, baseSpeed - speedReduction);
            
            setTimeout(() => {
                let maxRoll = 0;
                
                for (let i = 0; i < totalRollers; i++) {
                    const baseRng = calculateRNG();
                    const variant = getVariant();
                    const finalRng = baseRng * variant.multipliesRNG;
                    
                    if (finalRng > maxRoll) maxRoll = finalRng;
                    
                    const secret = checkSecret();
                    const rankName = secret || getRank(baseRng);
                    
                    // Track discoveries
                    discovered.variants.add(variant.name);
                    discovered.ranks.add(rankName);
                    if (secret) discovered.secrets.add(secret);
                    
                    const gain = Math.floor(Math.pow(finalRng, 0.8) * 0.75);
                    polycoin += gain;
                    totalRolls++;
                    
                    if (finalRng > bestRoll) {
                        bestRoll = finalRng;
                    }
                    
                    const generatedEnchants = generateEnchants(baseRng);
                    generatedEnchants.forEach(e => discovered.enchants.add(e.name));
                    
                    displayRoll(i, baseRng, finalRng, rankName, variant.name, generatedEnchants);
                    
                    pendingRolls[i] = {
                        baseRng: baseRng,
                        finalRng: finalRng,
                        rank: rankName,
                        variant: variant.name,
                        enchants: generatedEnchants,
                        timestamp: Date.now()
                    };
                }
                
                updateUI();
                updateIndex();
                saveGame();
                isRolling = false;
                
                // Apply cooldown if threshold is met
                if (cooldownThreshold > 0 && maxRoll >= cooldownThreshold) {
                    let countdown = cooldownTime;
                    const rollBtn = document.getElementById('rollBtn');
                    rollBtn.textContent = `cooldown: ${countdown.toFixed(1)}s`;
                    
                    const interval = setInterval(() => {
                        countdown -= 0.1;
                        if (countdown <= 0) {
                            clearInterval(interval);
                            rollBtn.textContent = 'roll';
                            rollBtn.disabled = false;
                        } else {
                            rollBtn.textContent = `cooldown: ${countdown.toFixed(1)}s`;
                        }
                    }, 100);
                } else {
                    document.getElementById('rollBtn').disabled = false;
                }
            }, rollSpeed * 1000);
        }

        function buyUpgrade(type) {
            if (type === 'bulk') {
                if (bulkLevel >= 3 || polycoin < bulkCost) return;
                polycoin -= bulkCost;
                bulkLevel++;
                bulkCost *= 100;
                updateRollers();
            } else if (type === 'luck') {
                if (luckLevel >= 100 || polycoin < luckCost) return;
                polycoin -= luckCost;
                luckLevel++;
                luckCost = Math.floor(luckCost * 1.15);
            } else if (type === 'secret') {
                if (secretLevel >= 25 || polycoin < secretCost) return;
                polycoin -= secretCost;
                secretLevel++;
                secretCost = Math.floor(secretCost * 1.3333);
            } else if (type === 'speed') {
                if (speedLevel >= 25 || polycoin < speedCost) return;
                polycoin -= speedCost;
                speedLevel++;
                speedCost = Math.floor(speedCost * 1.15);
            } else if (type === 'inventory') {
                const nextInvCost = calculateInvCost();
                if (invLevel >= 40 || polycoin < nextInvCost) return;
                polycoin -= nextInvCost;
                invLevel++;
            } else if (type === 'enchantLuck') {
                if (enchantLuckLevel >= 15 || polycoin < enchantLuckCost) return;
                polycoin -= enchantLuckCost;
                enchantLuckLevel++;
                enchantLuckCost = Math.floor(enchantLuckCost * 1.175);
            } else if (type === 'variantLuck') {
                if (variantLuckLevel >= 30 || polycoin < variantLuckCost) return;
                polycoin -= variantLuckCost;
                variantLuckLevel++;
                variantLuckCost = Math.floor(variantLuckCost * 1.2);
            }
            updateUI();
            saveGame();
        }

        function updateInventory() {
            const list = document.getElementById('inventoryList');
            const maxSlots = 10 + invLevel;
            
            document.getElementById('invCount').textContent = inventory.length;
            document.getElementById('invMax').textContent = maxSlots;
            
            if (inventory.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999;">no accepted rolls yet!</div>';
                return;
            }
            
            list.innerHTML = inventory.map((item, index) => {
                const color = getRNGColor(item.finalRng);
                let style = `color: ${color};`;
                if (color.includes('gradient')) {
                    style = `background: ${color}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;`;
                }
                
                const enchantsHTML = item.enchants && item.enchants.length > 0 
                    ? `<div style="font-size: 12px; color: #666;">+${item.enchants.length} enchants</div>`
                    : '';
                
                return `
                    <div class="inventory-item">
                        <div>
                            <span class="inventory-rng" style="${style}">${item.finalRng.toFixed(2)}</span>
                            <div class="inventory-details">${item.rank} - ${item.variant} (x${Math.round(item.finalRng/item.baseRng)})</div>
                            ${enchantsHTML}
                        </div>
                        <button class="decline-btn" onclick="deleteInventoryItem(${index})" style="padding: 5px 15px; font-size: 12px;">delete</button>
                    </div>
                `;
            }).join('');
        }

        function getEnchantDescription(enchant, stars = 0) {
            const starBonus = stars > 0 ? ` (${1 + stars * 0.2}x)` : '';
            
            if (enchant.type === 'luck') {
                const val = applyStarBonus(enchant.value, stars);
                return `+${val.toFixed(1)} luck${starBonus}`;
            }
            if (enchant.type === 'speed') {
                const val = applyStarBonus(enchant.value, stars);
                return `+${val.toFixed(2)}s speed${starBonus}`;
            }
            if (enchant.type === 'secret') {
                const val = applyStarBonus(enchant.value, stars);
                return `+${val.toFixed(1)} secret${starBonus}`;
            }
            if (enchant.type === 'variant') {
                const val = applyStarBonus(enchant.value, stars);
                return `+${val.toFixed(1)} variant luck${starBonus}`;
            }
            if (enchant.type === 'addition') return `+${enchant.value} bulk roll`;
            if (enchant.type === 'requiem') {
                if (enchant.value === 1) {
                    const luck = applyStarBonus(5, stars);
                    const speed = applyStarBonus(0.25, stars);
                    const secret = applyStarBonus(5, stars);
                    const variant = applyStarBonus(0.5, stars);
                    return `+${luck.toFixed(1)} luck, +${speed.toFixed(2)}s speed, +${secret.toFixed(1)} secret, +${variant.toFixed(1)} variant, +1 bulk${starBonus}`;
                }
                if (enchant.value === 2) {
                    const luck = applyStarBonus(10, stars);
                    const speed = applyStarBonus(0.5, stars);
                    const secret = applyStarBonus(25, stars);
                    const variant = applyStarBonus(2.5, stars);
                    return `+${luck.toFixed(1)} luck, +${speed.toFixed(2)}s speed, +${secret.toFixed(1)} secret, +${variant.toFixed(1)} variant, +2 bulk${starBonus}`;
                }
                if (enchant.value === 3) {
                    const luck = applyStarBonus(50, stars);
                    const speed = applyStarBonus(75, stars);
                    const secret = applyStarBonus(125, stars);
                    const variant = applyStarBonus(20, stars);
                    return `+${luck.toFixed(1)} luck, +${speed.toFixed(2)}s speed, +${secret.toFixed(1)} secret, +${variant.toFixed(1)} variant, +5 bulk${starBonus}`;
                }
            }
            if (enchant.type === 'greed') {
                const luck = applyStarBonus(20, stars);
                const speed = applyStarBonus(0.7, stars);
                return `+2 bulk roll, -${luck.toFixed(1)} luck, -${speed.toFixed(2)}s speed${starBonus}`;
            }
            if (enchant.type === 'patience') {
                const luck = applyStarBonus(100, stars);
                const speed = applyStarBonus(25, stars);
                const variant = applyStarBonus(5, stars);
                return `+3 bulk roll, +${luck.toFixed(1)} luck, -${speed.toFixed(2)}s speed, +${variant.toFixed(1)} variant${starBonus}`;
            }
            return '';
        }

        function updateCooldownSettings() {
            cooldownThreshold = parseFloat(document.getElementById('cooldownThreshold').value) || 0;
            cooldownTime = parseFloat(document.getElementById('cooldownTime').value) || 3;
            saveGame();
        }

        function getStarDisplay(stars) {
            if (!stars || stars === 0) return '';
            return '‚≠ê'.repeat(stars);
        }

        function updateEnchantInventory() {
            const equippedList = document.getElementById('equippedEnchant');
            const inventoryList = document.getElementById('enchantInventoryList');
            document.getElementById('enchantCount').textContent = enchantOrbs.length;
            document.getElementById('enchants').textContent = enchantOrbs.length;
            
            // Update equipped orb display
            if (!equippedOrb) {
                equippedList.innerHTML = '<div style="text-align: center; color: #999;">no enchant orb equipped!</div>';
            } else {
                const starDisplay = getStarDisplay(equippedOrb.stars);
                const enchantsList = equippedOrb.enchants.map(e => 
                    `<span style="color: ${e.color}; font-weight: bold;">${e.name}</span>`
                ).join(', ');
                
                const effectsList = equippedOrb.enchants.map(e => getEnchantDescription(e, equippedOrb.stars)).join(' | ');
                
                equippedList.innerHTML = `
                    <div class="inventory-item">
                        <div>
                            ${starDisplay ? `<div class="star-display">${starDisplay}</div>` : ''}
                            <div style="margin-bottom: 5px;">${enchantsList}</div>
                            <div style="font-size: 12px; color: #666;">${effectsList}</div>
                            <div style="font-size: 11px; color: #999;">from: ${equippedOrb.sourceRNG ? equippedOrb.sourceRNG.toFixed(2) : '?'} ${equippedOrb.variant || ''}</div>
                        </div>
                        <button class="unequip-btn" onclick="unequipEnchantOrb()" style="padding: 5px 15px; font-size: 12px;">unequip</button>
                    </div>
                `;
            }
            
            // Update enchant orbs list
            if (enchantOrbs.length === 0) {
                inventoryList.innerHTML = '<div style="text-align: center; color: #999;">no enchant orbs yet!</div>';
                return;
            }
            
            inventoryList.innerHTML = enchantOrbs.map((orb, index) => {
                const starDisplay = getStarDisplay(orb.stars);
                const enchantsList = orb.enchants.map(e => 
                    `<span style="color: ${e.color}; font-weight: bold;">${e.name}</span>`
                ).join(', ');
                
                const effectsList = orb.enchants.map(e => getEnchantDescription(e, orb.stars)).join(' | ');
                
                const isEquipped = equippedOrb && equippedOrb.id === orb.id;
                
                return `
                    <div class="inventory-item">
                        <div>
                            ${starDisplay ? `<div class="star-display">${starDisplay}</div>` : ''}
                            <div style="margin-bottom: 5px;">${enchantsList}</div>
                            <div style="font-size: 12px; color: #666;">${effectsList}</div>
                            <div style="font-size: 11px; color: #999;">from: ${orb.sourceRNG ? orb.sourceRNG.toFixed(2) : '?'} ${orb.variant || ''}</div>
                        </div>
                        <div>
                            ${isEquipped ? 
                                '<span style="color: #90ee90; font-size: 12px;">equipped</span>' : 
                                `<button class="equip-btn" onclick="equipEnchantOrb(${index})" style="padding: 5px 10px; font-size: 11px;">equip</button>`
                            }
                            <button class="decline-btn" onclick="deleteEnchantOrb(${index})" style="padding: 5px 10px; font-size: 11px;">delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateIndex() {
            // variants index
            const variantsHTML = VARIANTS.map(v => {
                const isDiscovered = discovered.variants.has(v.name);
                const icon = isDiscovered ? '‚úì' : '‚úó';
                const style = isDiscovered ? 'color: #90ee90;' : 'color: #ff6666;';
                return `<div class="index-item"><span style="${style}">${icon}</span> ${v.name}: ${v.multipliesRNG}x (1/${v.chance})</div>`;
            }).join('');
            document.getElementById('variantsIndex').innerHTML = variantsHTML;
            
            // ranks index
            const ranksHTML = RANKS.map(r => {
                const isDiscovered = discovered.ranks.has(r.name);
                const icon = isDiscovered ? '‚úì' : '‚úó';
                const style = isDiscovered ? 'color: #90ee90;' : 'color: #ff6666;';
                return `<div class="index-item"><span style="${style}">${icon}</span> ${r.name}: ${r.min} - ${r.max === Infinity ? '‚àû' : r.max}</div>`;
            }).join('');
            document.getElementById('ranksIndex').innerHTML = ranksHTML;
            
            // secrets index
            const secretsHTML = SECRETS.map(s => {
                const isDiscovered = discovered.secrets.has(s.name);
                const icon = isDiscovered ? '‚úì' : '‚úó';
                const style = isDiscovered ? 'color: #90ee90;' : 'color: #ff6666;';
                return `<div class="index-item"><span style="${style}">${icon}</span> ${s.name}: 1/${s.chance}</div>`;
            }).join('');
            document.getElementById('secretsIndex').innerHTML = secretsHTML;
            
            // enchants index
            const enchantsHTML = ENCHANT_TYPES.map(enchant => {
                const isDiscovered = discovered.enchants.has(enchant.name);
                const icon = isDiscovered ? '‚úì' : '‚úó';
                const style = isDiscovered ? 'color: #90ee90;' : 'color: #ff6666;';
                let effect = '';
                if (enchant.type === 'luck') effect = `+${enchant.value} luck`;
                if (enchant.type === 'speed') effect = `+${enchant.value}s speed`;
                if (enchant.type === 'secret') effect = `+${enchant.value} secret`;
                if (enchant.type === 'variant') effect = `+${enchant.value} variant luck`;
                if (enchant.type === 'addition') effect = `+${enchant.value} bulk roll`;
                if (enchant.type === 'requiem') {
                    if (enchant.value === 1) effect = '+5 luck, +0.25s speed, +5 secret, +0.5 variant, +1 bulk';
                    else if (enchant.value === 2) effect = '+10 luck, +0.5s speed, +25 secret, +2.5 variant, +2 bulk';
                    else if (enchant.value === 3) effect = '+50 luck, +75s speed, +125 secret, +20 variant, +5 bulk';
                }
                if (enchant.type === 'greed') effect = '+2 bulk roll, -20 luck, -0.7s speed';
                if (enchant.type === 'patience') effect = '+3 bulk roll, +100 luck, -25s speed, +5 variant';
                const chanceDisplay = Math.round(1/enchant.chance);
                return `<div class="index-item"><span style="${style}">${icon}</span> ${enchant.name}: ${effect} (1/${chanceDisplay})</div>`;
            }).join('');
            document.getElementById('enchantsIndex').innerHTML = enchantsHTML;
        }

        function calculateInvCost() {
            if (invLevel === 0) return 0;
            return Math.floor(20 * Math.log(invLevel) / Math.log(3));
        }

        function updateUI() {
            document.getElementById('polycoin').textContent = Math.floor(polycoin).toLocaleString();
            document.getElementById('best').textContent = bestRoll.toFixed(2);
            document.getElementById('rolls').textContent = totalRolls.toLocaleString();
            
            document.getElementById('bulkLevel').textContent = bulkLevel;
            document.getElementById('bulkCost').textContent = bulkCost.toLocaleString();
            document.getElementById('bulkBtn').disabled = bulkLevel >= 3 || polycoin < bulkCost;
            
            document.getElementById('luckLevel').textContent = luckLevel;
            document.getElementById('luckAmount').textContent = (luckLevel * 0.5).toFixed(1);
            document.getElementById('luckCost').textContent = luckCost.toLocaleString();
            document.getElementById('luckBtn').disabled = luckLevel >= 100 || polycoin < luckCost;
            
            document.getElementById('secretLevel').textContent = secretLevel;
            document.getElementById('secretAmount').textContent = (secretLevel * 0.2).toFixed(1);
            document.getElementById('secretCost').textContent = secretCost.toLocaleString();
            document.getElementById('secretBtn').disabled = secretLevel >= 25 || polycoin < secretCost;
            
            const totalSpeedReduction = speedLevel * 0.1 + getTotalEnchantSpeed();
            document.getElementById('speedLevel').textContent = speedLevel;
            document.getElementById('speedAmount').textContent = Math.max(0.05, 3 - totalSpeedReduction).toFixed(2);
            document.getElementById('speedCost').textContent = speedCost.toLocaleString();
            document.getElementById('speedBtn').disabled = speedLevel >= 25 || polycoin < speedCost;
            
            const nextInvCost = calculateInvCost();
            document.getElementById('invLevel').textContent = 10 + invLevel;
            document.getElementById('invCost').textContent = nextInvCost.toLocaleString();
            document.getElementById('invBtn').disabled = invLevel >= 40 || polycoin < nextInvCost;
            
            document.getElementById('enchantLuckLevel').textContent = enchantLuckLevel;
            document.getElementById('enchantLuckAmount').textContent = (enchantLuckLevel * 0.05).toFixed(2);
            document.getElementById('enchantLuckCost').textContent = enchantLuckCost.toLocaleString();
            document.getElementById('enchantLuckBtn').disabled = enchantLuckLevel >= 15 || polycoin < enchantLuckCost;
            
            document.getElementById('variantLuckLevel').textContent = variantLuckLevel;
            document.getElementById('variantLuckAmount').textContent = (variantLuckLevel * 0.05).toFixed(2);
            document.getElementById('variantLuckCost').textContent = variantLuckCost.toLocaleString();
            document.getElementById('variantLuckBtn').disabled = variantLuckLevel >= 30 || polycoin < variantLuckCost;
        }

        function saveGame() {
            try {
                const saveData = {
                    polycoin,
                    bestRoll,
                    totalRolls,
                    bulkLevel,
                    bulkCost,
                    luckLevel,
                    luckCost,
                    secretLevel,
                    secretCost,
                    speedLevel,
                    speedCost,
                    invLevel,
                    enchantLuckLevel,
                    enchantLuckCost,
                    variantLuckLevel,
                    variantLuckCost,
                    cooldownThreshold,
                    cooldownTime,
                    discovered: {
                        variants: Array.from(discovered.variants),
                        ranks: Array.from(discovered.ranks),
                        secrets: Array.from(discovered.secrets),
                        enchants: Array.from(discovered.enchants)
                    },
                    inventory: inventory.map(item => ({
                        ...item,
                        enchants: item.enchants ? item.enchants.map(e => ({
                            name: e.name,
                            type: e.type,
                            value: e.value,
                            color: e.color,
                            priority: e.priority
                        })) : []
                    })),
                    enchantOrbs: enchantOrbs.map(orb => ({
                        id: orb.id,
                        enchants: orb.enchants.map(e => ({
                            name: e.name,
                            type: e.type,
                            value: e.value,
                            color: e.color,
                            priority: e.priority
                        })),
                        sourceRNG: orb.sourceRNG,
                        variant: orb.variant,
                        stars: orb.stars || 0
                    })),
                    equippedOrb: equippedOrb ? {
                        id: equippedOrb.id,
                        enchants: equippedOrb.enchants.map(e => ({
                            name: e.name,
                            type: e.type,
                            value: e.value,
                            color: e.color,
                            priority: e.priority
                        })),
                        sourceRNG: equippedOrb.sourceRNG,
                        variant: equippedOrb.variant,
                        stars: equippedOrb.stars || 0
                    } : null
                };
                localStorage.setItem('polys-rng-save', JSON.stringify(saveData));
            } catch (error) {
                console.error('failed to save game:', error);
            }
        }

        function loadGame() {
            try {
                const result = localStorage.getItem('polys-rng-save');
                if (result) {
                    const saveData = JSON.parse(result);
                    
                    polycoin = saveData.polycoin || 0;
                    bestRoll = saveData.bestRoll || 0;
                    totalRolls = saveData.totalRolls || 0;
                    bulkLevel = saveData.bulkLevel || 1;
                    bulkCost = saveData.bulkCost || 100;
                    luckLevel = saveData.luckLevel || 0;
                    luckCost = saveData.luckCost || 10;
                    secretLevel = saveData.secretLevel || 0;
                    secretCost = saveData.secretCost || 50;
                    speedLevel = saveData.speedLevel || 0;
                    speedCost = saveData.speedCost || 50;
                    invLevel = saveData.invLevel || 0;
                    enchantLuckLevel = saveData.enchantLuckLevel || 0;
                    enchantLuckCost = saveData.enchantLuckCost || 30;
                    variantLuckLevel = saveData.variantLuckLevel || 0;
                    variantLuckCost = saveData.variantLuckCost || 50;
                    
                    cooldownThreshold = saveData.cooldownThreshold || 0;
                    cooldownTime = saveData.cooldownTime || 3;
                    document.getElementById('cooldownThreshold').value = cooldownThreshold;
                    document.getElementById('cooldownTime').value = cooldownTime;
                    
                    if (saveData.discovered) {
                        discovered.variants = new Set(saveData.discovered.variants || []);
                        discovered.ranks = new Set(saveData.discovered.ranks || []);
                        discovered.secrets = new Set(saveData.discovered.secrets || []);
                        discovered.enchants = new Set(saveData.discovered.enchants || []);
                    }
                    
                    inventory = saveData.inventory || [];
                    inventory.forEach(item => {
                        if (!item.enchants) item.enchants = [];
                    });
                    
                    enchantOrbs = saveData.enchantOrbs || [];
                    enchantOrbs.forEach(orb => {
                        if (orb.stars === undefined) orb.stars = 0;
                    });
                    
                    equippedOrb = saveData.equippedOrb || null;
                    if (equippedOrb && equippedOrb.stars === undefined) {
                        equippedOrb.stars = 0;
                    }
                }
            } catch (error) {
                console.log('no save data found or error loading:', error);
                equippedOrb = null;
            }
            
            updateRollers();
            updateInventory();
            updateEnchantInventory();
            updateIndex();
            updateUI();
        }

        // initialize
        updateRollers();
        updateUI();
        updateIndex();
        
        // Make inventory and enchant sections open by default
        document.getElementById('inventoryContent').classList.add('open');
        document.getElementById('enchantsContent').classList.add('open');
    </script>
</body>
</html>
