<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>polys silly rngame</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: arial, sans-serif;
            background: linear-gradient(135deg, #ffc0cb 0%, #ffffff 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #ff69b4;
            margin-bottom: 30px;
            text-transform: lowercase;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .stat-box {
            background: #f0f0f0;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            text-transform: lowercase;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff69b4;
        }
        .rollers-container {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .roll-display {
            background: #ffffff;
            border: 3px solid #ff69b4;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            width: 180px;
            height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .variant-box {
            background: #ff69b4;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 5px;
            text-transform: lowercase;
        }
        .rng-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
        }
        .roll-result {
            font-size: 28px;
            margin-bottom: 5px;
        }
        .roll-name {
            font-size: 16px;
            color: #ff69b4;
            text-transform: lowercase;
        }
        .enchants-box {
            background: #f0f0f0;
            padding: 5px;
            border-radius: 5px;
            font-size: 12px;
            margin-top: 5px;
            min-height: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 3px;
        }
        .enchant-tag {
            background: #9370db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            text-transform: lowercase;
        }
        .accept-btn {
            background: #ff69b4;
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .decline-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .accept-btn:hover {
            background: #ff85c1;
        }
        .decline-btn:hover {
            background: #ff6666;
        }
        .roll-actions {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        button {
            background: #666;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            text-transform: lowercase;
        }
        button:hover {
            background: #888;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .button-container {
            text-align: center;
            margin-bottom: 30px;
        }
        .sections-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        @media (max-width: 900px) {
            .sections-container {
                grid-template-columns: 1fr;
            }
        }
        .upgrades-section, .inventory-section {
            margin-top: 20px;
        }
        .upgrades-header, .inventory-header, .enchants-header, .index-header {
            background: #666;
            color: white;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            user-select: none;
            margin-bottom: 10px;
            text-transform: lowercase;
        }
        .upgrades-header:hover, .inventory-header:hover, .enchants-header:hover, .index-header:hover {
            background: #888;
        }
        .upgrades-content, .inventory-content, .enchants-content, .index-content {
            display: none;
        }
        .upgrades-content.open, .inventory-content.open, .enchants-content.open, .index-content.open {
            display: block;
        }
        .upgrade-box {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ddd;
            margin-bottom: 10px;
        }
        .upgrade-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff69b4;
            text-transform: lowercase;
        }
        .upgrade-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .inventory, .enchant-inventory {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .inventory-title, .enchant-title {
            font-weight: bold;
            font-size: 18px;
            color: #ff69b4;
            margin-bottom: 15px;
            text-transform: lowercase;
        }
        .inventory-item, .enchant-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .inventory-rng {
            font-weight: bold;
            font-size: 16px;
        }
        .inventory-details {
            font-size: 14px;
            color: #666;
            text-transform: lowercase;
        }
        .index-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .index-category {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
        }
        .index-title {
            font-weight: bold;
            color: #ff69b4;
            margin-bottom: 10px;
            border-bottom: 2px solid #ff69b4;
            padding-bottom: 5px;
            text-transform: lowercase;
        }
        .index-item {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #eee;
            text-transform: lowercase;
        }
        @keyframes flip {
            0% { transform: rotateX(0deg); }
            50% { transform: rotateX(180deg); }
            100% { transform: rotateX(360deg); }
        }
        .flipping {
            animation: flip 0.2s linear infinite;
        }
        .cube {
            display: inline-block;
            width: 80px;
            height: 80px;
            line-height: 80px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #ff69b4, #9370db);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            perspective: 1000px;
        }
        .equip-btn {
            background: #90ee90;
            color: black;
            border: none;
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }
        .unequip-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>polys silly rngame</h1>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">polycoin</div>
                <div class="stat-value" id="polycoin">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">best roll</div>
                <div class="stat-value" id="best">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">total rolls</div>
                <div class="stat-value" id="rolls">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">enchants</div>
                <div class="stat-value" id="enchants">0</div>
            </div>
        </div>

        <div class="rollers-container" id="rollersContainer">
            <!-- rollers will be generated here -->
        </div>

        <div class="button-container">
            <button onclick="roll()" id="rollBtn">roll</button>
        </div>

        <div class="sections-container">
            <div class="left-column">
                <div class="upgrades-section">
                    <div class="upgrades-header" onclick="toggleSection('upgradesContent')">
                        ‚öôÔ∏è upgrades (click to expand) ‚öôÔ∏è
                    </div>
                    <div class="upgrades-content" id="upgradesContent">
                        <div class="upgrade-box">
                            <div class="upgrade-title">add roller</div>
                            <div class="upgrade-info">rollers: <span id="bulkLevel">1</span>/3</div>
                            <div class="upgrade-info">effect: +1 roller on screen</div>
                            <button onclick="buyUpgrade('bulk')" id="bulkBtn">buy (cost: <span id="bulkCost">100</span>)</button>
                        </div>
                        <div class="upgrade-box">
                            <div class="upgrade-title">luck boost</div>
                            <div class="upgrade-info">level: <span id="luckLevel">0</span>/100</div>
                            <div class="upgrade-info">effect: +<span id="luckAmount">0</span> luck</div>
                            <button onclick="buyUpgrade('luck')" id="luckBtn">buy (cost: <span id="luckCost">10</span>)</button>
                        </div>
                        <div class="upgrade-box">
                            <div class="upgrade-title">secret luck</div>
                            <div class="upgrade-info">level: <span id="secretLevel">0</span>/25</div>
                            <div class="upgrade-info">effect: +<span id="secretAmount">0</span> secret luck</div>
                            <button onclick="buyUpgrade('secret')" id="secretBtn">buy (cost: <span id="secretCost">50</span>)</button>
                        </div>
                        <div class="upgrade-box">
                            <div class="upgrade-title">roll speed</div>
                            <div class="upgrade-info">level: <span id="speedLevel">0</span>/25</div>
                            <div class="upgrade-info">speed: <span id="speedAmount">3.0</span>s</div>
                            <button onclick="buyUpgrade('speed')" id="speedBtn">buy (cost: <span id="speedCost">50</span>)</button>
                        </div>
                        <div class="upgrade-box">
                            <div class="upgrade-title">inventory slots</div>
                            <div class="upgrade-info">slots: <span id="invLevel">10</span>/50</div>
                            <div class="upgrade-info">effect: +1 inventory slot</div>
                            <button onclick="buyUpgrade('inventory')" id="invBtn">buy (cost: <span id="invCost">0</span>)</button>
                        </div>
                    </div>
                </div>

                <div class="inventory-section">
                    <div class="inventory-header" onclick="toggleSection('inventoryContent')">
                        üì¶ inventory (<span id="invCount">0</span>/<span id="invMax">10</span>)
                    </div>
                    <div class="inventory-content open" id="inventoryContent">
                        <div class="inventory" id="inventoryList"></div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="enchants-section">
                    <div class="enchants-header" onclick="toggleSection('enchantsContent')">
                        üîÆ enchants (<span id="enchantCount">0</span>)
                    </div>
                    <div class="enchants-content open" id="enchantsContent">
                        <div class="inventory-title">equipped</div>
                        <div class="inventory" id="equippedEnchant"></div>
                        <div class="inventory-title" style="margin-top: 15px;">inventory</div>
                        <div class="inventory" id="enchantInventoryList"></div>
                    </div>
                </div>

                <div class="index-section">
                    <div class="index-header" onclick="toggleSection('indexContent')">
                        üìö index (click to expand)
                    </div>
                    <div class="index-content" id="indexContent">
                        <div class="index-grid">
                            <div class="index-category">
                                <div class="index-title">variants</div>
                                <div id="variantsIndex"></div>
                            </div>
                            <div class="index-category">
                                <div class="index-title">ranks</div>
                                <div id="ranksIndex"></div>
                            </div>
                            <div class="index-category">
                                <div class="index-title">secrets</div>
                                <div id="secretsIndex"></div>
                            </div>
                            <div class="index-category">
                                <div class="index-title">enchants</div>
                                <div id="enchantsIndex"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // game constants
        const VARIANTS = [
            { name: 'normal', chance: 1, multipliesRNG: 1 },
            { name: 'shiny', chance: 10, multipliesRNG: 10 },
            { name: 'better', chance: 25, multipliesRNG: 25 },
            { name: 'spectral', chance: 50, multipliesRNG: 50 },
            { name: 'divine', chance: 100, multipliesRNG: 100 },
            { name: 'chromatic', chance: 250, multipliesRNG: 250 },
            { name: 'inverted', chance: 500, multipliesRNG: 500 }
        ];

        const RANKS = [
            { name: 'common', min: 1, max: 5 },
            { name: 'rare', min: 5, max: 25 },
            { name: 'decent', min: 25, max: 50 },
            { name: 'natural', min: 50, max: 100 },
            { name: 'exceptional', min: 100, max: 250 },
            { name: 'eclipse', min: 250, max: 500 },
            { name: 'mythic', min: 500, max: 1000 },
            { name: 'divine', min: 1000, max: 5000 },
            { name: 'unordinary', min: 5000, max: 10000 },
            { name: 'unreal', min: 10000, max: 50000 },
            { name: 'eternal', min: 50000, max: 100000 },
            { name: 'iridescence', min: 100000, max: 500000 },
            { name: 'zeta', min: 500000, max: 1000000 },
            { name: 'fantasy', min: 1000000, max: Infinity }
        ];

        const SECRETS = [
            { name: 'weird', chance: 1000 },
            { name: 'grand', chance: 5000 },
            { name: 'defined', chance: 10000 },
            { name: 'nil', chance: 50000 },
            { name: 'impossible', chance: 100000 }
        ];

        const ENCHANT_TYPES = {
            'luck i': { chance: 1/1.5, type: 'luck', value: 5, color: '#90ee90' },
            'luck ii': { chance: 1/5, type: 'luck', value: 10, color: '#00ff00' },
            'speed i': { chance: 1/2.5, type: 'speed', value: -0.25, color: '#87ceeb' },
            'speed ii': { chance: 1/10, type: 'speed', value: -0.5, color: '#1e90ff' },
            'insight i': { chance: 1/10, type: 'secret', value: 5, color: '#9370db' },
            'insight ii': { chance: 1/50, type: 'secret', value: 25, color: '#8a2be2' },
            'requiem i': { chance: 1/500, type: 'requiem', value: 1, color: '#ff4500' },
            'requiem ii': { chance: 1/10000, type: 'requiem', value: 2, color: '#dc143c' }
        };

        // game state
        let polycoin = 0;
        let bestRoll = 0;
        let totalRolls = 0;
        let bulkLevel = 1;
        let bulkCost = 100;
        let luckLevel = 0;
        let luckCost = 10;
        let secretLevel = 0;
        let secretCost = 50;
        let speedLevel = 0;
        let speedCost = 50;
        let invLevel = 0;
        let invCost = 0;
        let isRolling = false;
        let inventory = [];
        let enchantInventory = [];
        let equippedEnchant = null;
        let pendingRolls = {};

        // load game on start
        loadGame();

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            if (content) {
                content.classList.toggle('open');
            }
        }

        function getRNGColor(rng) {
            if (rng < 10) return '#000000';
            if (rng < 100) return '#ffc0cb';
            if (rng < 1000) return '#90ee90';
            if (rng < 10000) return '#9370db';
            if (rng < 100000) return 'linear-gradient(90deg, #ff0000, #ffffff)';
            if (rng < 1000000) return 'linear-gradient(90deg, #00ffff, #ffffff)';
            if (rng < 10000000) return 'linear-gradient(90deg, #000000, #8b0000)';
            return 'linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3)';
        }

        function calculateRNG() {
            const luck = luckLevel * 0.5 + getTotalEnchantLuck();
            const rng = Math.random() ** (-1.3 - (luck * 0.01));
            return Math.max(1, rng);
        }

        function getTotalEnchantLuck() {
            let total = 0;
            if (equippedEnchant) {
                if (equippedEnchant.type === 'luck') total += equippedEnchant.value;
                if (equippedEnchant.type === 'requiem') total += (equippedEnchant.value === 1 ? 5 : 10);
            }
            return total;
        }

        function getTotalEnchantSecret() {
            let total = 0;
            if (equippedEnchant) {
                if (equippedEnchant.type === 'secret') total += equippedEnchant.value;
                if (equippedEnchant.type === 'requiem') total += (equippedEnchant.value === 1 ? 5 : 25);
            }
            return total;
        }

        function getTotalEnchantSpeed() {
            let total = 0;
            if (equippedEnchant) {
                if (equippedEnchant.type === 'speed') total += equippedEnchant.value;
                if (equippedEnchant.type === 'requiem') total += (equippedEnchant.value === 1 ? -0.25 : -0.5);
            }
            return total;
        }

        function getRank(rng) {
            for (let i = RANKS.length - 1; i >= 0; i--) {
                if (rng >= RANKS[i].min) {
                    return RANKS[i].name;
                }
            }
            return RANKS[0].name;
        }

        function getVariant() {
            for (let i = VARIANTS.length - 1; i >= 0; i--) {
                const random = Math.random();
                if (random <= 1 / VARIANTS[i].chance) {
                    return VARIANTS[i];
                }
            }
            return VARIANTS[0];
        }

        function checkSecret() {
            const secretLuck = secretLevel * 0.2 + getTotalEnchantSecret();
            const random = Math.random();
            for (let i = SECRETS.length - 1; i >= 0; i--) {
                const adjustedChance = SECRETS[i].chance / (1 + secretLuck);
                if (random <= 1 / adjustedChance) {
                    return SECRETS[i].name;
                }
            }
            return null;
        }

        function generateEnchants(baseRng) {
            if (baseRng < 500) return [];
            
            const generated = [];
            const typesFound = new Set();
            
            // Convert ENCHANT_TYPES object to array
            const enchantArray = Object.entries(ENCHANT_TYPES).map(([name, data]) => ({
                name: name,
                chance: data.chance,
                type: data.type,
                value: data.value,
                color: data.color
            }));
            
            enchantArray.forEach(enchant => {
                if (Math.random() <= enchant.chance && !typesFound.has(enchant.type)) {
                    generated.push({
                        name: enchant.name,
                        type: enchant.type,
                        value: enchant.value,
                        color: enchant.color
                    });
                    typesFound.add(enchant.type);
                }
            });
            
            return generated;
        }

        function updateRollers() {
            const container = document.getElementById('rollersContainer');
            container.innerHTML = '';
            for (let i = 0; i < bulkLevel; i++) {
                const roller = document.createElement('div');
                roller.className = 'roll-display';
                roller.id = `roller-${i}`;
                roller.innerHTML = `
                    <div class="variant-box"></div>
                    <div class="rng-box">
                        <div class="roll-result">press roll!</div>
                        <div class="roll-name"></div>
                    </div>
                    <div class="enchants-box"></div>
                    <div class="roll-actions" style="display: none;">
                        <button class="accept-btn" onclick="acceptRoll(${i})">‚úì accept</button>
                        <button class="decline-btn" onclick="declineRoll(${i})">‚úó decline</button>
                    </div>
                `;
                container.appendChild(roller);
            }
        }

        function animateRoller(index) {
            const roller = document.getElementById(`roller-${index}`);
            if (!roller) return;
            
            const resultEl = roller.querySelector('.roll-result');
            const variantBox = roller.querySelector('.variant-box');
            const nameEl = roller.querySelector('.roll-name');
            const enchantsBox = roller.querySelector('.enchants-box');
            
            resultEl.classList.add('flipping');
            variantBox.textContent = '';
            nameEl.textContent = '';
            enchantsBox.innerHTML = '';
            
            // create single flipping cube
            const cubeContainer = document.createElement('div');
            cubeContainer.className = 'cube flipping';
            cubeContainer.style.display = 'flex';
            cubeContainer.style.justifyContent = 'center';
            cubeContainer.style.alignItems = 'center';
            resultEl.innerHTML = '';
            resultEl.appendChild(cubeContainer);
            
            let counter = 0;
            const interval = setInterval(() => {
                // use the same rng formula for animation numbers
                const animatedRNG = Math.random() ** (-1.3 - (luckLevel * 0.5 * 0.01));
                cubeContainer.textContent = Math.max(1, animatedRNG * 10).toFixed(0);
                counter++;
                if (counter >= 15) {
                    clearInterval(interval);
                    resultEl.classList.remove('flipping');
                }
            }, 200);
        }

        function displayRoll(index, baseRng, finalRng, rankName, variantName, generatedEnchants) {
            const roller = document.getElementById(`roller-${index}`);
            if (!roller) return;
            
            const resultEl = roller.querySelector('.roll-result');
            const variantBox = roller.querySelector('.variant-box');
            const nameEl = roller.querySelector('.roll-name');
            const enchantsBox = roller.querySelector('.enchants-box');
            const actionElements = roller.querySelector('.roll-actions');
            
            // clear animation cube
            resultEl.innerHTML = '';
            resultEl.textContent = finalRng.toFixed(2);
            
            variantBox.textContent = variantName;
            nameEl.textContent = rankName;
            
            // display enchants
            if (generatedEnchants && generatedEnchants.length > 0) {
                enchantsBox.innerHTML = generatedEnchants.map(enchant => 
                    `<span class="enchant-tag" style="background: ${enchant.color}">${enchant.name}</span>`
                ).join('');
            }
            
            actionElements.style.display = 'flex';
            
            const color = getRNGColor(finalRng);
            if (color.includes('gradient')) {
                resultEl.style.background = color;
                resultEl.style.webkitBackgroundClip = 'text';
                resultEl.style.webkitTextFillColor = 'transparent';
                resultEl.style.backgroundClip = 'text';
            } else {
                resultEl.style.background = 'none';
                resultEl.style.webkitTextFillColor = 'inherit';
                resultEl.style.color = color;
            }
        }

        function acceptRoll(index) {
            if (!pendingRolls[index]) return;
            
            const maxSlots = 10 + invLevel;
            if (inventory.length >= maxSlots) {
                alert('inventory is full! buy more slots or decline some rolls.');
                return;
            }
            
            // add to inventory
            inventory.unshift(pendingRolls[index]);
            
            // add enchants to enchant inventory
            if (pendingRolls[index].enchants && pendingRolls[index].enchants.length > 0) {
                pendingRolls[index].enchants.forEach(enchant => {
                    enchantInventory.push({
                        ...enchant,
                        id: Date.now() + Math.random(),
                        sourceRNG: pendingRolls[index].finalRng,
                        variant: pendingRolls[index].variant
                    });
                });
            }
            
            delete pendingRolls[index];
            
            const roller = document.getElementById(`roller-${index}`);
            if (roller) {
                const actionElements = roller.querySelector('.roll-actions');
                actionElements.style.display = 'none';
            }
            
            updateInventory();
            updateEnchantInventory();
            updateUI();
            saveGame();
        }

        function declineRoll(index) {
            if (!pendingRolls[index]) return;
            
            delete pendingRolls[index];
            
            const roller = document.getElementById(`roller-${index}`);
            if (roller) {
                const actionElements = roller.querySelector('.roll-actions');
                actionElements.style.display = 'none';
            }
        }

        function deleteInventoryItem(index) {
            inventory.splice(index, 1);
            updateInventory();
            saveGame();
        }

        function deleteEnchantItem(index) {
            // If deleting equipped enchant, unequip it first
            if (equippedEnchant && equippedEnchant.id === enchantInventory[index].id) {
                equippedEnchant = null;
            }
            enchantInventory.splice(index, 1);
            updateEnchantInventory();
            updateUI();
            saveGame();
        }

        function equipEnchant(index) {
            equippedEnchant = enchantInventory[index];
            updateEnchantInventory();
            updateUI();
            saveGame();
        }

        function unequipEnchant() {
            equippedEnchant = null;
            updateEnchantInventory();
            updateUI();
            saveGame();
        }

        function roll() {
            if (isRolling) return;
            
            isRolling = true;
            document.getElementById('rollBtn').disabled = true;
            
            for (let i = 0; i < bulkLevel; i++) {
                animateRoller(i);
            }
            
            const baseSpeed = 3;
            const speedReduction = speedLevel * 0.1 + getTotalEnchantSpeed();
            const rollSpeed = Math.max(0.5, baseSpeed - speedReduction);
            
            setTimeout(() => {
                for (let i = 0; i < bulkLevel; i++) {
                    const baseRng = calculateRNG();
                    const variant = getVariant();
                    const finalRng = baseRng * variant.multipliesRNG;
                    
                    // Get rank from BASE RNG (not affected by variant)
                    const secret = checkSecret();
                    const rankName = secret || getRank(baseRng);
                    
                    const gain = Math.floor(Math.pow(finalRng, 0.8) * 0.75);
                    polycoin += gain;
                    totalRolls++;
                    
                    if (finalRng > bestRoll) {
                        bestRoll = finalRng;
                    }
                    
                    const generatedEnchants = generateEnchants(baseRng);
                    
                    displayRoll(i, baseRng, finalRng, rankName, variant.name, generatedEnchants);
                    
                    pendingRolls[i] = {
                        baseRng: baseRng,
                        finalRng: finalRng,
                        rank: rankName,
                        variant: variant.name,
                        enchants: generatedEnchants,
                        timestamp: Date.now()
                    };
                }
                
                updateUI();
                saveGame();
                isRolling = false;
                document.getElementById('rollBtn').disabled = false;
            }, rollSpeed * 1000);
        }

        function buyUpgrade(type) {
            if (type === 'bulk') {
                if (bulkLevel >= 3 || polycoin < bulkCost) return;
                polycoin -= bulkCost;
                bulkLevel++;
                bulkCost *= 100;
                updateRollers();
            } else if (type === 'luck') {
                if (luckLevel >= 100 || polycoin < luckCost) return;
                polycoin -= luckCost;
                luckLevel++;
                luckCost = Math.floor(luckCost * 1.15);
            } else if (type === 'secret') {
                if (secretLevel >= 25 || polycoin < secretCost) return;
                polycoin -= secretCost;
                secretLevel++;
                secretCost = Math.floor(secretCost * 1.3333);
            } else if (type === 'speed') {
                if (speedLevel >= 25 || polycoin < speedCost) return;
                polycoin -= speedCost;
                speedLevel++;
                speedCost = Math.floor(speedCost * 1.15);
            } else if (type === 'inventory') {
                const nextInvCost = calculateInvCost();
                if (invLevel >= 40 || polycoin < nextInvCost) return;
                polycoin -= nextInvCost;
                invLevel++;
            }
            updateUI();
            saveGame();
        }

        function updateInventory() {
            const list = document.getElementById('inventoryList');
            const maxSlots = 10 + invLevel;
            
            document.getElementById('invCount').textContent = inventory.length;
            document.getElementById('invMax').textContent = maxSlots;
            
            if (inventory.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999;">no accepted rolls yet!</div>';
                return;
            }
            
            list.innerHTML = inventory.map((item, index) => {
                const color = getRNGColor(item.finalRng);
                let style = `color: ${color};`;
                if (color.includes('gradient')) {
                    style = `background: ${color}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;`;
                }
                
                const enchantsHTML = item.enchants && item.enchants.length > 0 
                    ? `<div style="font-size: 12px; color: #666;">+${item.enchants.length} enchants</div>`
                    : '';
                
                return `
                    <div class="inventory-item">
                        <div>
                            <span class="inventory-rng" style="${style}">${item.finalRng.toFixed(2)}</span>
                            <div class="inventory-details">${item.rank} - ${item.variant} (x${Math.round(item.finalRng/item.baseRng)})</div>
                            ${enchantsHTML}
                        </div>
                        <button class="decline-btn" onclick="deleteInventoryItem(${index})" style="padding: 5px 15px; font-size: 12px;">delete</button>
                    </div>
                `;
            }).join('');
        }

        function updateEnchantInventory() {
            const equippedList = document.getElementById('equippedEnchant');
            const inventoryList = document.getElementById('enchantInventoryList');
            document.getElementById('enchantCount').textContent = enchantInventory.length;
            document.getElementById('enchants').textContent = enchantInventory.length;
            
            // Update equipped enchant display
            if (!equippedEnchant) {
                equippedList.innerHTML = '<div style="text-align: center; color: #999;">no enchant equipped!</div>';
            } else {
                let effectText = '';
                if (equippedEnchant.type === 'luck') effectText = `+${equippedEnchant.value} luck`;
                if (equippedEnchant.type === 'speed') effectText = `${equippedEnchant.value}s speed`;
                if (equippedEnchant.type === 'secret') effectText = `+${equippedEnchant.value} secret`;
                if (equippedEnchant.type === 'requiem') {
                    effectText = equippedEnchant.value === 1 
                        ? '+5 luck, -0.25s speed, +5 secret'
                        : '+10 luck, -0.5s speed, +25 secret';
                }
                
                equippedList.innerHTML = `
                    <div class="inventory-item">
                        <div>
                            <span style="color: ${equippedEnchant.color}; font-weight: bold;">${equippedEnchant.name}</span>
                            <div style="font-size: 12px; color: #666;">${effectText}</div>
                            <div style="font-size: 11px; color: #999;">from: ${equippedEnchant.sourceRNG.toFixed(2)} ${equippedEnchant.variant}</div>
                        </div>
                        <button class="unequip-btn" onclick="unequipEnchant()" style="padding: 5px 15px; font-size: 12px;">unequip</button>
                    </div>
                `;
            }
            
            // Update enchant inventory list
            if (enchantInventory.length === 0) {
                inventoryList.innerHTML = '<div style="text-align: center; color: #999;">no enchants yet!</div>';
                return;
            }
            
            inventoryList.innerHTML = enchantInventory.map((enchant, index) => {
                let effectText = '';
                if (enchant.type === 'luck') effectText = `+${enchant.value} luck`;
                if (enchant.type === 'speed') effectText = `${enchant.value}s speed`;
                if (enchant.type === 'secret') effectText = `+${enchant.value} secret`;
                if (enchant.type === 'requiem') {
                    effectText = enchant.value === 1 
                        ? '+5 luck, -0.25s speed, +5 secret'
                        : '+10 luck, -0.5s speed, +25 secret';
                }
                
                const isEquipped = equippedEnchant && equippedEnchant.id === enchant.id;
                
                return `
                    <div class="inventory-item">
                        <div>
                            <span style="color: ${enchant.color}; font-weight: bold;">${enchant.name}</span>
                            <div style="font-size: 12px; color: #666;">${effectText}</div>
                            <div style="font-size: 11px; color: #999;">from: ${enchant.sourceRNG.toFixed(2)} ${enchant.variant}</div>
                        </div>
                        <div>
                            ${isEquipped ? 
                                '<span style="color: #90ee90; font-size: 12px;">equipped</span>' : 
                                `<button class="equip-btn" onclick="equipEnchant(${index})" style="padding: 5px 10px; font-size: 11px;">equip</button>`
                            }
                            <button class="decline-btn" onclick="deleteEnchantItem(${index})" style="padding: 5px 10px; font-size: 11px;">delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateIndex() {
            // variants index
            const variantsHTML = VARIANTS.map(v => 
                `<div class="index-item">${v.name}: ${v.multipliesRNG}x (1/${v.chance})</div>`
            ).join('');
            document.getElementById('variantsIndex').innerHTML = variantsHTML;
            
            // ranks index
            const ranksHTML = RANKS.map(r => 
                `<div class="index-item">${r.name}: ${r.min} - ${r.max === Infinity ? '‚àû' : r.max}</div>`
            ).join('');
            document.getElementById('ranksIndex').innerHTML = ranksHTML;
            
            // secrets index
            const secretsHTML = SECRETS.map(s => 
                `<div class="index-item">${s.name}: 1/${s.chance}</div>`
            ).join('');
            document.getElementById('secretsIndex').innerHTML = secretsHTML;
            
            // enchants index
            const enchantsHTML = Object.entries(ENCHANT_TYPES).map(([name, data]) => {
                let effect = '';
                if (data.type === 'luck') effect = `+${data.value} luck`;
                if (data.type === 'speed') effect = `${data.value}s speed`;
                if (data.type === 'secret') effect = `+${data.value} secret`;
                if (data.type === 'requiem') {
                    effect = data.value === 1 
                        ? '+5 luck, -0.25s speed, +5 secret'
                        : '+10 luck, -0.5s speed, +25 secret';
                }
                const chanceDisplay = Math.round(1/data.chance);
                return `<div class="index-item">${name}: ${effect} (1/${chanceDisplay})</div>`;
            }).join('');
            document.getElementById('enchantsIndex').innerHTML = enchantsHTML;
        }

        function calculateInvCost() {
            if (invLevel === 0) return 0;
            return Math.floor(20 * Math.log(invLevel) / Math.log(3));
        }

        function updateUI() {
            document.getElementById('polycoin').textContent = Math.floor(polycoin).toLocaleString();
            document.getElementById('best').textContent = bestRoll.toFixed(2);
            document.getElementById('rolls').textContent = totalRolls.toLocaleString();
            
            document.getElementById('bulkLevel').textContent = bulkLevel;
            document.getElementById('bulkCost').textContent = bulkCost.toLocaleString();
            document.getElementById('bulkBtn').disabled = bulkLevel >= 3 || polycoin < bulkCost;
            
            document.getElementById('luckLevel').textContent = luckLevel;
            document.getElementById('luckAmount').textContent = (luckLevel * 0.5).toFixed(1);
            document.getElementById('luckCost').textContent = luckCost.toLocaleString();
            document.getElementById('luckBtn').disabled = luckLevel >= 100 || polycoin < luckCost;
            
            document.getElementById('secretLevel').textContent = secretLevel;
            document.getElementById('secretAmount').textContent = (secretLevel * 0.2).toFixed(1);
            document.getElementById('secretCost').textContent = secretCost.toLocaleString();
            document.getElementById('secretBtn').disabled = secretLevel >= 25 || polycoin < secretCost;
            
            const totalSpeedReduction = speedLevel * 0.1 + getTotalEnchantSpeed();
            document.getElementById('speedLevel').textContent = speedLevel;
            document.getElementById('speedAmount').textContent = Math.max(0.5, 3 - totalSpeedReduction).toFixed(1);
            document.getElementById('speedCost').textContent = speedCost.toLocaleString();
            document.getElementById('speedBtn').disabled = speedLevel >= 25 || polycoin < speedCost;
            
            const nextInvCost = calculateInvCost();
            document.getElementById('invLevel').textContent = 10 + invLevel;
            document.getElementById('invCost').textContent = nextInvCost.toLocaleString();
            document.getElementById('invBtn').disabled = invLevel >= 40 || polycoin < nextInvCost;
        }

        function saveGame() {
            try {
                const saveData = {
                    polycoin,
                    bestRoll,
                    totalRolls,
                    bulkLevel,
                    bulkCost,
                    luckLevel,
                    luckCost,
                    secretLevel,
                    secretCost,
                    speedLevel,
                    speedCost,
                    invLevel,
                    inventory,
                    enchantInventory,
                    equippedEnchant
                };
                localStorage.setItem('polys-rng-save', JSON.stringify(saveData));
            } catch (error) {
                console.error('failed to save game:', error);
            }
        }

        function loadGame() {
            try {
                const result = localStorage.getItem('polys-rng-save');
                if (result) {
                    const saveData = JSON.parse(result);
                    polycoin = saveData.polycoin || 0;
                    bestRoll = saveData.bestRoll || 0;
                    totalRolls = saveData.totalRolls || 0;
                    bulkLevel = saveData.bulkLevel || 1;
                    bulkCost = saveData.bulkCost || 100;
                    luckLevel = saveData.luckLevel || 0;
                    luckCost = saveData.luckCost || 10;
                    secretLevel = saveData.secretLevel || 0;
                    secretCost = saveData.secretCost || 50;
                    speedLevel = saveData.speedLevel || 0;
                    speedCost = saveData.speedCost || 50;
                    invLevel = saveData.invLevel || 0;
                    inventory = saveData.inventory || [];
                    enchantInventory = saveData.enchantInventory || [];
                    equippedEnchant = saveData.equippedEnchant || null;
                }
            } catch (error) {
                console.log('no save data found or error loading:', error);
            }
            
            updateRollers();
            updateInventory();
            updateEnchantInventory();
            updateIndex();
            updateUI();
        }

        // initialize
        updateRollers();
        updateUI();
        updateIndex();
        
        // Make inventory and enchant sections open by default
        document.getElementById('inventoryContent').classList.add('open');
        document.getElementById('enchantsContent').classList.add('open');
    </script>
</body>
</html>